---
title: "Tutorial"
author: "Morgan Kelly"
editor: visual
format:
  html:
    toc: true
    html-math-method: katex
    css: styles.css
execute:
  freeze: auto 
---
```{r setup}
library(spatInfer)
```

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The html_vignette output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible.

```{r}
library(spatInfer)

data(opportunity)
set.seed(123)
opportunity=opportunity |> dplyr::slice_sample(n=100)
```

## 1. Choose the Spatial Basis

Now run the regression and print output

```{r fig-basis, fig.height=4, fig.width=5, Cache=FALSE}
optimal_basis(mobility~racial_seg+single_mom, opportunity,
              max_splines=5)
```

## 2. Run Placebo Test

next run placebo test.

```{r placebo, Cache=FALSE}
plbo=placebo(mobility~racial_seg+single_mom, opportunity,
                 splines=4, pc_num=3,
                 nSim=50,
                 Parallel=T
                 )
placebo_table(plbo)

```

## 3. Run a Synthetic Outcome Test

Following the placebo test, the next step is to calculate the synthetic outcome p-value: What is the significance level of the null hypothesis that the outcome is determined by trending noise of a specified form?

We assume that the outcome is generated as a quadratic in longitude and latitude with residuals again being generated by a spatial noise process with the same exponential parameters: here there is a structure of 0.37 and effective range of 0.1.

``` {r}
synt_bch=synth_bch(mobility~racial_seg+single_mom,  opportunity,
                 splines=4, pc_num=3,
                  nSim=50,
                 Parallel=T)
synth_table(synt_bch)
```

For the three clusters chosen by the placebo test, the synthetic outcome significance level is 0.02, identical to the placebo one.

## 4. Estimate the Spatial Basis Regression

The fact that the placebo and synthetic outcome significance levels closely match the regression one gives us considerable confidence in the reliability of the regression estimate. We therefore estimate a regression with 4 principal components of a 4x4 spline, and compute standard errors using 3 k-medoids clusters.

For comparison we also include a regression with no spatial adjustment where standard errors are clustered by state.

``` {r}
CK=CK_regression(mobility~racial_seg+single_mom,  opportunity,
                 splines=4,pc_num=3,
                 clusters=3)

Clust=fixest::feols(mobility~racial_seg+single_mom,  opportunity,
              cluster= ~state)

modelsummary::modelsummary(list(Clustered=Clust, Basis=CK),
                           statistic = c("conf.int","p = {p.value}"),
                           coef_omit = c("Intercept|PC*"), #omit basis and intercept
                           gof_map = c("nobs", "r.squared"),
                            fmt=2)
```

It can be seen here that, despite the strong spatial trends in the data, adding a spline basis and using only three clusters does not alter the results markedly compared with naive clustering by state.