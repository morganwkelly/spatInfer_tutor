<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="">

<title>spatInfer Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#choose-the-spatial-basis" id="toc-choose-the-spatial-basis" class="nav-link active" data-scroll-target="#choose-the-spatial-basis">1. Choose the Spatial Basis</a></li>
  <li><a href="#run-placebo-test" id="toc-run-placebo-test" class="nav-link" data-scroll-target="#run-placebo-test">2. Run Placebo Test</a></li>
  <li><a href="#run-a-synthetic-outcome-test" id="toc-run-a-synthetic-outcome-test" class="nav-link" data-scroll-target="#run-a-synthetic-outcome-test">3. Run a Synthetic Outcome Test</a></li>
  <li><a href="#estimate-the-spatial-basis-regression" id="toc-estimate-the-spatial-basis-regression" class="nav-link" data-scroll-target="#estimate-the-spatial-basis-regression">4. Estimate the Spatial Basis Regression</a></li>
  <li><a href="#im-inference" id="toc-im-inference" class="nav-link" data-scroll-target="#im-inference">IM Inference</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">spatInfer Tutorial</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The purpose of <code>spatInfer</code> is to estimate regressions that are robust to the long range trends and medium range autocorrelation that are a feature of spatial observations. Specifically, a spatial basis is added to the regression and standard errors are estimated using large clusters. A feature of <code>spatInfer</code> is its simple workflow, requiring a sequence of only four commands.</p>
<p>The four steps in estimating a spatial basis regression with large cluster inference are</p>
<ul>
<li><p>Estimate the optimal spatial basis.</p></li>
<li><p>Generate a spatial noise placebo to select the number of clusters for standard error estimation and estimate the placebo significance level of the treatment.</p></li>
<li><p>Generate synthetic outcomes to test the null hypothesis that the outcome is spatial noise, independent of the treatment.</p></li>
<li><p>Estimate a spatial basis regression using the parameters estimated in the first two steps.</p></li>
</ul>
<p>The first step is to download spatInfer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("morganwkelly/spatInfer")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We begin by loading the <code>spatInfer</code> library and the data frame called <code>opportunity</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatInfer)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tinytable)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(opportunity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The example we will use here is based on the second column of Table VI in Chetty et al’s examination of income mobility across US cities. This consists of the outcome, absolute upward mobility, the treatment of interest fraction of single mothers, and four other controls: fraction short commute, Gini bottom 99%, high school dropout rate, and social capital index. Observations for Alaska and Hawaii are omitted to allow meaningful spatial correlations to be estimated. The longitude and latitude of each observation are included in the data. These must be named <code>X</code> and <code>Y</code>.</p>
<section id="choose-the-spatial-basis" class="level2">
<h2 class="anchored" data-anchor-id="choose-the-spatial-basis">1. Choose the Spatial Basis</h2>
<p>The first step is to estimate the optimal spatial basis that best explains the outcome variable. The spatial basis serves both to remove long range structure from the data (acting like a systematic version of the 49 state dummies included in the original regression) and to improve inference by allowing smaller clusters of residuals.</p>
<p>We apply the simplest basis possible: a <span class="math inline">k \times k</span> tensor of linear b-splines and, to minimize the loss of degrees of freedom, we select the first <span class="math inline">p</span> principal components of the tensor. The first command `optimal_basis` chooses the combination of <span class="math inline">k</span> and <span class="math inline">p</span> that minimizes a Bayes Information Criterion. To make the diagram legible, select the maximum basis degree that you want to examine. As with most commands in <code>R</code> it starts with the regression formula and the name of the dataset. Here we will regress mobility on five variables used in Table VI of Chetty et al: the choice of right hand side variables does not matter at this stage.</p>
<p>The treatment of interest is placed as the first on the right hand side. If several are of concern the procedure can be repeated using each as the first entry.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">optimal_basis</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,  opportunity,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a> <span class="at">max_splines=</span><span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-basis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial_files/figure-html/fig-basis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Spline surface of social mobility.
</figcaption>
</figure>
</div>
</div>
</div>
<p>It can be seen here that the optimal combination is the first 15 principal components of a 6x6 spline. It is notable that this very small number of spatial controls explains 60% of variability in the outcome, compared with 64% obtained by using the 49 state dummies of the original study. Knowing only the location of a place lets you make a decent guess about the likely degree of mobility there, without knowing anything about its other characteristics.</p>
<p>It is useful to plot the tensor surface of intergenerational mobility to see how geometrically simple it is. In The viewpoint is from the southeast of the US and the angular surface reflects the fact that a product of linear B-splines (series of overlapping triangles) is used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_basis</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>           gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,    opportunity,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">splines=</span><span class="dv">6</span>, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">Title=</span><span class="st">"6x6 Tensor Surface of Mobility"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-spline" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tutorial_files/figure-html/fig-spline-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-spline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Spline surface of social mobility.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="run-placebo-test" class="level2">
<h2 class="anchored" data-anchor-id="run-placebo-test">2. Run Placebo Test</h2>
<p>Having chosen a spatial basis, we now need to choose an optimal number of clusters for the residuals. If there are too many, residuals will be correlated between clusters leading to inconsistent standard error estimates, whereas too few will result in unnecessarily wide confidence intervals. To choose the optimal number we use spatial noise placebos.</p>
<p>The placebos are constructed to have the same spatial structure as the treatment, here single mothers. First, the treatment is regressed on the spatial basis terms selected in Step 1. The spatial correlation between the detrended residuals is assumed to decay exponentially so that the correlation between two at distance <span class="math inline">h</span> apart is <span class="math inline">\rho \exp (- \theta / h)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The parameters <span class="math inline">\rho</span> and <span class="math inline">\theta</span> are referred to as the structure and range of the correlation. Effective range is <span class="math inline">2 \theta</span>: at this distance correlation equals 0.14. These parameters are estimated by maximum likelihood using the <code>fields</code> library and then used to estimate synthetic residuals which are added back onto the predicted treatment values to give the placebo values. The regression is run repeatedly with simulated placebos in place of the real treatment and the p-values of each simulation are recorded.</p>
<p>These placebo p-values give us two useful things. The first is a placebo significance level of the treatment: how often does a placebo have a lower p-value (higher t-statistic) than the treatment.</p>
<p>The second is that the placebos provide a Monte Carlo simulation to evaluate the inference procedure used. If substantially more than 5% of placebo regressions are significant at 5% we can conclude that the standard error estimate is deficient.</p>
<p>Standard errors are estimated using the large cluster procedure of Bester, Conley and Hansen, where observations are partitioned into <span class="math inline">c</span> large clusters using k-medoids. The placebo Monte Carlos allow an optimal value of <span class="math inline">c</span> to be picked.</p>
<p>The placebo test is implemented by the command `placebo`. Again this starts off with the formula and data, followed by the tensor degree and number of principal components just picked by <code>optimal_basis</code>, and then the number of simulations. In practice the simulations settle down rapidly and 1000 will give accurate results but you may want to start with around 200 which will quickly give you a good idea of how your data are behaving.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell" data-cache="true">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>plbo<span class="ot">=</span><span class="fu">placebo</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,                                 opportunity,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">splines=</span><span class="dv">6</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nSim=</span><span class="dv">1000</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_clus =</span> <span class="dv">7</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">placebo_table</span>(plbo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_027he1jz6zn7p5zvnye1(i, j, css_id) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_027he1jz6zn7p5zvnye1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_027he1jz6zn7p5zvnye1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 1, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 2, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 3, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 4, 'tinytable_css_idqd09xlgiyg3kq7r37947') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 5, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 6, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 0, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 1, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 2, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 3, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 4, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 5, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 6, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
    </script>

    <style>
    .table td.tinytable_css_idawe3k5o28d4kimo7zhgg, .table th.tinytable_css_idawe3k5o28d4kimo7zhgg {  font-weight: bold; }
    .table td.tinytable_css_idqd09xlgiyg3kq7r37947, .table th.tinytable_css_idqd09xlgiyg3kq7r37947 {  color: orange;  font-weight: bold; }
    .table td.tinytable_css_id874rui7dfo8uyunayt32, .table th.tinytable_css_id874rui7dfo8uyunayt32 {  color: orange; }
    .table td.tinytable_css_idz8ro3t9ki96hmq92qjlj, .table th.tinytable_css_idz8ro3t9ki96hmq92qjlj {  text-align: left; }
    </style>
    <div class="container">
      <table class="table table-striped" id="tinytable_027he1jz6zn7p5zvnye1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">Adj</th>
                <th scope="col">Clusters</th>
                <th scope="col">Est p</th>
                <th scope="col">Plac p</th>
                <th scope="col">Plac 5%</th>
                <th scope="col">CI Width</th>
                <th scope="col">CI</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="7">Moran=15.69, Structure=0.96, Effective Range=0.05, R2=0.46.</td></tr>
<tr><td colspan="7">Splines=6, PCs=15.</td></tr>
<tr><td colspan="7">Estimated and placebo p values and proportion of placebo regressions significant at 5%, along
                with confidence intervals. R2 gives the explanatory power of a regression of the treatment on the principal components.</td></tr></tfoot>
        <tbody>
                <tr>
                  <td>HC </td>
                  <td>.</td>
                  <td>0    </td>
                  <td>0    </td>
                  <td>0.13 </td>
                  <td>0.28</td>
                  <td>[-1.14, -0.86]</td>
                </tr>
                <tr>
                  <td>BCH</td>
                  <td>3</td>
                  <td>0.075</td>
                  <td>0.09 </td>
                  <td>0.057</td>
                  <td>2.49</td>
                  <td>[-2.25, 0.25] </td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>4</td>
                  <td>0.038</td>
                  <td>0.058</td>
                  <td>0.076</td>
                  <td>1.8 </td>
                  <td>[-1.9, -0.1]  </td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>5</td>
                  <td>0.02 </td>
                  <td>0.015</td>
                  <td>0.062</td>
                  <td>1.48</td>
                  <td>[-1.74, -0.26]</td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>6</td>
                  <td>0.012</td>
                  <td>0.013</td>
                  <td>0.06 </td>
                  <td>1.33</td>
                  <td>[-1.66, -0.34]</td>
                </tr>
                <tr>
                  <td>BCH</td>
                  <td>7</td>
                  <td>0.003</td>
                  <td>0.008</td>
                  <td>0.08 </td>
                  <td>1.01</td>
                  <td>[-1.51, -0.49]</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>Placebo generates a table where the top row uses heteroskedasticity consistent standard errors: if spatial correlation in residuals turns out to be unimportant these are the ones to use. Below this are large cluster (Bester-Conley-Hansen) standard errors, starting with three and going up to six. The second column gives the estimated p-value of the treatment variable from a regression that includes spatial basis terms. As the number of clusters increases this will generally fall.</p>
<p>The next column gives the placebo p-value: the proportion of simulations where the placebo had a lower p-value than the real treatment.</p>
<p>Following this, and highlighted in orange, is the percentage of simulations where the placebo is significant at 5%. If this is markedly higher than 5% it suggests that the inference method employed was inadequate. In practice a value in the range of 0.05 to 0.07 or 0.08 indicates satisfactory performance.</p>
<p>The next column gives the width of the confidence interval associated with each cluster and allows an informal size-power tradeoff: increasing the proportion above 5% to, say, 7% is desirable if it leads to a marked narrowing of the confidence interval. In this case here, 5 or 6 clusters give very similar values with 6% of simulations significant at 5% suggesting that these are reasonable numbers: by contrast 13% of HC simulations are significant. We will report regression results for both below. For six clusters the placebo p-value of 0.01 equals the regression estimate of 0.01 and the confidence interval for the parameter is [-1.66,-0.34].</p>
<p>It will sometimes happen that the proportion of placebos significant at 5% stays considerably above 5% regardless of the cluster number. In that case systematically increasing, or sometimes decreasing, the number of principal components <code>num_pc</code> by one or two will usually give a satisfactory placebo value.</p>
<p>Below the Table are a number of diagnostics and descriptive statistics. Most important is the Moran statistic, the Z-score of the null hypothesis that the correlation between each residual and its nearest neighbours is zero. We use 5 neighbours here: altering this does not alter the results materially.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>In deciding whether to use a familiar HC standard error or a large cluster one we have adopted the rule of thumb that if this has a low Moran statistic and a 5% placebo value close to 0.05 it should be used, given its tighter confidence intervals. Otherwise a BCH cluster below 0.08 is picked.</p>
<p>Below the Moran statistic are the spatial parameters. R2 gives the explanatory power of the regression of the treatment on the spatial basis variables, in this case 0.46. Next is the structure <span class="math inline">\rho</span> of the residuals and then the effective range (where correlation has fallen to 0.14) expressed as a fraction of the 95th percentile of distance between points.</p>
<p>Here it can be seen that structure and effective range are 0.96 and 0.05 respectively. Finally the degree of the tensor and the number of principal components used to approximate the outcome are reported.</p>
</section>
<section id="run-a-synthetic-outcome-test" class="level2">
<h2 class="anchored" data-anchor-id="run-a-synthetic-outcome-test">3. Run a Synthetic Outcome Test</h2>
<p>Following the placebo test, the next step is to calculate the synthetic outcome p-value: Can we reject the null hypothesis that the outcome is trending spatial noise, and therefore independent of the treatment?</p>
<p>An important thing about the synthetic outcome test is that it can be computed in situations where there is a binary treatment so a placebo test cannot be estimated. In this case it is best to report the p-values for a range of cluster values from 3 to 5 or more to allow readers to judge the robustness of the results.</p>
<p>We assume that the outcome is generated as a quadratic in longitude and latitude. Noise is generated using maximum likelihood estimates of the residuals’ spatial parameters: here there is a structure of 0.88 and an effective range of 0.15.</p>
<div class="cell" data-cache="true">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>synt_bch<span class="ot">=</span><span class="fu">synth</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,                                 opportunity,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">splines=</span><span class="dv">6</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nSim=</span><span class="dv">1000</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_clus =</span> <span class="dv">7</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">synth_table</span>(synt_bch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_027he1jz6zn7p5zvnye1(i, j, css_id) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_027he1jz6zn7p5zvnye1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_027he1jz6zn7p5zvnye1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 0, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 1, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 2, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 3, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 4, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 5, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
    </script>

    <style>
    .table td.tinytable_css_id4sdwb22hjpaxoer2o5re, .table th.tinytable_css_id4sdwb22hjpaxoer2o5re {  font-weight: bold; }
    .table td.tinytable_css_idyq617yg1vg6szqf21uv4, .table th.tinytable_css_idyq617yg1vg6szqf21uv4 {  text-align: left; }
    </style>
    <div class="container">
      <table class="table table-striped" id="tinytable_027he1jz6zn7p5zvnye1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">Adj</th>
                <th scope="col">Clusters</th>
                <th scope="col">Est p</th>
                <th scope="col">Synth p</th>
                <th scope="col">CI Width</th>
                <th scope="col">CI</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="6">Moran=15.69, Structure=0.88, Effective Range=0.15, R2=0.43.</td></tr>
<tr><td colspan="6">N=693, Splines=6, PCs=15.</td></tr>
<tr><td colspan="6">Estimated and synthetic outcome p values for different cluster numbers.
                R2 gives the explanatory power of a regression of the outcome on a quadratic in longitude and latitude.</td></tr></tfoot>
        <tbody>
                <tr>
                  <td>HC </td>
                  <td>.</td>
                  <td>0    </td>
                  <td>0    </td>
                  <td>0.28</td>
                  <td>[-1.14, -0.86]</td>
                </tr>
                <tr>
                  <td>BCH</td>
                  <td>3</td>
                  <td>0.075</td>
                  <td>0.14 </td>
                  <td>2.49</td>
                  <td>[-2.25, 0.25] </td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>4</td>
                  <td>0.038</td>
                  <td>0.059</td>
                  <td>1.8 </td>
                  <td>[-1.9, -0.1]  </td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>5</td>
                  <td>0.02 </td>
                  <td>0.041</td>
                  <td>1.48</td>
                  <td>[-1.74, -0.26]</td>
                </tr>
                <tr>
                  <td>   </td>
                  <td>6</td>
                  <td>0.012</td>
                  <td>0.041</td>
                  <td>1.33</td>
                  <td>[-1.66, -0.34]</td>
                </tr>
                <tr>
                  <td>BCH</td>
                  <td>7</td>
                  <td>0.003</td>
                  <td>0.011</td>
                  <td>1.01</td>
                  <td>[-1.51, -0.49]</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>For the five or six clusters chosen by the placebo test, the synthetic outcome significance level is 0.04, somewhat higher than the placebo one.</p>
</section>
<section id="estimate-the-spatial-basis-regression" class="level2">
<h2 class="anchored" data-anchor-id="estimate-the-spatial-basis-regression">4. Estimate the Spatial Basis Regression</h2>
<p>The fact that the placebo and synthetic outcome significance levels closely match the regression one gives us considerable confidence in the reliability of the regression estimate. We therefore estimate a regression with 15 principal components of a 6x6 spline, and compute standard errors using both five and six k-medoids clusters.</p>
<p>For comparison we also include the original regression with state dummies and residuals clustered by state. The state dummies act as a spatial basis in this regression with 48 variables as opposed to the 15 used in the basis regressions.</p>
<p>Because t-statistics for BCH regressions are not readily interpretable given their low degrees of freedom (for instance, the 5% significance level for 5 clusters is 2.8), the Table reports confidence intervals and p-values.</p>
<div class="cell" data-cache="true">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Basis_5<span class="ot">=</span><span class="fu">basis_regression</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na, opportunity,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="at">splines=</span><span class="dv">6</span>,<span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="at">clusters=</span><span class="dv">5</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>Basis_6<span class="ot">=</span><span class="fu">basis_regression</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na, opportunity,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">splines=</span><span class="dv">6</span>,<span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">clusters=</span><span class="dv">6</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>Original<span class="ot">=</span>fixest<span class="sc">::</span><span class="fu">feols</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na<span class="sc">+</span>state_id, opportunity,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">cluster=</span> <span class="sc">~</span>state_id)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="at">Clustered=</span>Original, </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Basis 5</span><span class="st">`</span><span class="ot">=</span>Basis_5,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Basis 6</span><span class="st">`</span><span class="ot">=</span>Basis_6),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">statistic =</span> <span class="fu">c</span>(<span class="st">"conf.int"</span>,<span class="st">"p = {p.value}"</span>),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="at">coef_omit =</span> <span class="fu">c</span>(<span class="st">"Intercept|PC*|dropout_na|state*"</span>), <span class="co">#omit basis and intercept</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="at">gof_map =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="at">fmt=</span><span class="dv">2</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="at">notes=</span><span class="st">"Clustered is a standard regression estimate without a spatial basis and clustered by state. Basis 5 and 6 use 11 principal components of a 6x6 linear b-spline basis, with 5 and 6 k-medoids clusters respectively."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_sv8v4e36l63ofkd40hk5(i, j, css_id) {
        var table = document.getElementById("tinytable_sv8v4e36l63ofkd40hk5");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_sv8v4e36l63ofkd40hk5');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_sv8v4e36l63ofkd40hk5(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_sv8v4e36l63ofkd40hk5");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(0, 0, 'tinytable_css_idyhaqw3grvhkvhbrmy6qs') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(0, 1, 'tinytable_css_idt7ssutoio613mnps7z2h') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(0, 2, 'tinytable_css_idt7ssutoio613mnps7z2h') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(0, 3, 'tinytable_css_idt7ssutoio613mnps7z2h') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(1, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(1, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(1, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(1, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(2, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(2, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(2, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(2, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(3, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(3, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(3, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(3, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(4, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(4, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(4, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(4, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(5, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(5, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(5, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(5, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(6, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(6, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(6, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(6, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(7, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(7, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(7, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(7, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(8, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(8, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(8, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(8, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(9, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(9, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(9, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(9, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(10, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(10, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(10, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(10, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(11, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(11, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(11, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(11, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(12, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(12, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(12, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(12, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(13, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(13, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(13, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(13, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(14, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(14, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(14, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(14, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(15, 0, 'tinytable_css_idf7gwlpj0e5l99tu1dmuz') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(15, 1, 'tinytable_css_idrpmztuzccs2vjklt00pu') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(15, 2, 'tinytable_css_idrpmztuzccs2vjklt00pu') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(15, 3, 'tinytable_css_idrpmztuzccs2vjklt00pu') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(16, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(16, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(16, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(16, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(17, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(17, 1, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(17, 2, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(17, 3, 'tinytable_css_idrfapgl7pweu07r6oc0vy') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(18, 0, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(18, 1, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(18, 2, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
window.addEventListener('load', function () { styleCell_sv8v4e36l63ofkd40hk5(18, 3, 'tinytable_css_idtt2rz8onlqm5q3f4axm2') })
    </script>

    <style>
    .table td.tinytable_css_idyhaqw3grvhkvhbrmy6qs, .table th.tinytable_css_idyhaqw3grvhkvhbrmy6qs {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idt7ssutoio613mnps7z2h, .table th.tinytable_css_idt7ssutoio613mnps7z2h {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idtt2rz8onlqm5q3f4axm2, .table th.tinytable_css_idtt2rz8onlqm5q3f4axm2 {  text-align: left; }
    .table td.tinytable_css_idrfapgl7pweu07r6oc0vy, .table th.tinytable_css_idrfapgl7pweu07r6oc0vy {  text-align: center; }
    .table td.tinytable_css_idf7gwlpj0e5l99tu1dmuz, .table th.tinytable_css_idf7gwlpj0e5l99tu1dmuz {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idrpmztuzccs2vjklt00pu, .table th.tinytable_css_idrpmztuzccs2vjklt00pu {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_sv8v4e36l63ofkd40hk5" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">Clustered</th>
                <th scope="col">Basis 5</th>
                <th scope="col">Basis 6</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="4">Clustered is a standard regression estimate without a spatial basis and clustered by state. Basis 5 and 6 use 11 principal components of a 6x6 linear b-spline basis, with 5 and 6 k-medoids clusters respectively.</td></tr></tfoot>
        <tbody>
                <tr>
                  <td>single_mothers</td>
                  <td>-0.49         </td>
                  <td>-0.51         </td>
                  <td>-0.51         </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>[-0.64, -0.35]</td>
                  <td>[-0.88, -0.13]</td>
                  <td>[-0.84, -0.17]</td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>p = &lt;0.01     </td>
                  <td>p = 0.02      </td>
                  <td>p = 0.01      </td>
                </tr>
                <tr>
                  <td>short_commute </td>
                  <td>0.31          </td>
                  <td>0.26          </td>
                  <td>0.26          </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>[0.25, 0.38]  </td>
                  <td>[0.05, 0.46]  </td>
                  <td>[0.10, 0.42]  </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>p = &lt;0.01     </td>
                  <td>p = 0.03      </td>
                  <td>p = &lt;0.01     </td>
                </tr>
                <tr>
                  <td>gini          </td>
                  <td>0.01          </td>
                  <td>0.00          </td>
                  <td>0.00          </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>[-0.06, 0.08] </td>
                  <td>[-0.09, 0.08] </td>
                  <td>[-0.06, 0.05] </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>p = 0.70      </td>
                  <td>p = 0.89      </td>
                  <td>p = 0.84      </td>
                </tr>
                <tr>
                  <td>dropout_rate  </td>
                  <td>-0.10         </td>
                  <td>-0.10         </td>
                  <td>-0.10         </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>[-0.17, -0.02]</td>
                  <td>[-0.24, 0.05] </td>
                  <td>[-0.20, 0.01] </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>p = 0.01      </td>
                  <td>p = 0.15      </td>
                  <td>p = 0.07      </td>
                </tr>
                <tr>
                  <td>social_cap    </td>
                  <td>0.05          </td>
                  <td>0.08          </td>
                  <td>0.08          </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>[-0.05, 0.15] </td>
                  <td>[-0.09, 0.25] </td>
                  <td>[-0.07, 0.23] </td>
                </tr>
                <tr>
                  <td>              </td>
                  <td>p = 0.29      </td>
                  <td>p = 0.26      </td>
                  <td>p = 0.23      </td>
                </tr>
                <tr>
                  <td>Num.Obs.      </td>
                  <td>693           </td>
                  <td>693           </td>
                  <td>693           </td>
                </tr>
                <tr>
                  <td>R2            </td>
                  <td>0.877         </td>
                  <td>0.842         </td>
                  <td>0.842         </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>Next we can plot confidence intervals for the regressions. It is evident that the confidence interval for single mothers has grown substantially wider, and that the effects of commuting distance and, especially, social capital have fallen considerably.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modelplot</span>(<span class="fu">list</span>(<span class="at">Clustered=</span>Original, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">Basis 5</span><span class="st">`</span><span class="ot">=</span>Basis_5,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Basis 6</span><span class="st">`</span><span class="ot">=</span>Basis_6),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">coef_omit =</span> <span class="fu">c</span>(<span class="st">"Intercept|PC*|dropout_na|state*"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                           )<span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">0</span>,<span class="at">color=</span><span class="st">"red"</span>,<span class="at">linewidth=</span><span class="fl">0.25</span>,<span class="at">linetype=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tutorial_files/figure-html/modelplot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Confidence intervals for clustered and spatial basis regressions.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="im-inference" class="level2">
<h2 class="anchored" data-anchor-id="im-inference">IM Inference</h2>
<p>Besides BCH standard errors, there is another spatial inferential method based on large clusters due to Ibragimov and Mueller. This involves running the regression of interest on each cluster and collecting the estimated coefficients of the treatment <span class="math inline">\hat{\beta}_c</span> for each cluster <span class="math inline">c</span>. The p-value of a regression of these coefficients on a constant is conservative up to a value of 0.08. Once again the optimal number of clusters is chosen by the fraction of placebo regressions that are significant at 5%.</p>
<div class="cell" data-cache="true">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plbo_im<span class="ot">=</span><span class="fu">placebo_im</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,                                 opportunity,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">splines=</span><span class="dv">6</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nSim=</span><span class="dv">1000</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_clus =</span> <span class="dv">7</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">placebo_table</span>(plbo_im)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_027he1jz6zn7p5zvnye1(i, j, css_id) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_027he1jz6zn7p5zvnye1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_027he1jz6zn7p5zvnye1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 1, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 2, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 3, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 4, 'tinytable_css_idqd09xlgiyg3kq7r37947') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 5, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 6, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 0, 'tinytable_css_idawe3k5o28d4kimo7zhgg') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 4, 'tinytable_css_id874rui7dfo8uyunayt32') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 0, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 1, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 2, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 3, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 4, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 5, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 6, 'tinytable_css_idz8ro3t9ki96hmq92qjlj') })
    </script>

    <style>
    .table td.tinytable_css_idawe3k5o28d4kimo7zhgg, .table th.tinytable_css_idawe3k5o28d4kimo7zhgg {  font-weight: bold; }
    .table td.tinytable_css_idqd09xlgiyg3kq7r37947, .table th.tinytable_css_idqd09xlgiyg3kq7r37947 {  color: orange;  font-weight: bold; }
    .table td.tinytable_css_id874rui7dfo8uyunayt32, .table th.tinytable_css_id874rui7dfo8uyunayt32 {  color: orange; }
    .table td.tinytable_css_idz8ro3t9ki96hmq92qjlj, .table th.tinytable_css_idz8ro3t9ki96hmq92qjlj {  text-align: left; }
    </style>
    <div class="container">
      <table class="table table-striped" id="tinytable_027he1jz6zn7p5zvnye1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">Adj</th>
                <th scope="col">Clusters</th>
                <th scope="col">Est p</th>
                <th scope="col">Plac p</th>
                <th scope="col">Plac 5%</th>
                <th scope="col">CI Width</th>
                <th scope="col">CI</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="7">Moran=15.69, Structure=0.96, Effective Range=0.05, R2=0.46.</td></tr>
<tr><td colspan="7">Splines=6, PCs=15.</td></tr>
<tr><td colspan="7">Estimated and placebo p values and proportion of placebo regressions significant at 5%, along
                with confidence intervals. R2 gives the explanatory power of a regression of the treatment on the principal components.</td></tr></tfoot>
        <tbody>
                <tr>
                  <td>HC</td>
                  <td>.</td>
                  <td>0    </td>
                  <td>0    </td>
                  <td>0.13 </td>
                  <td>0.28</td>
                  <td>[-1.14, -0.86]</td>
                </tr>
                <tr>
                  <td>IM</td>
                  <td>3</td>
                  <td>0.057</td>
                  <td>0.053</td>
                  <td>0.046</td>
                  <td>2.14</td>
                  <td>[-2.07, 0.07] </td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>4</td>
                  <td>0.023</td>
                  <td>0.024</td>
                  <td>0.046</td>
                  <td>1.48</td>
                  <td>[-1.74, -0.26]</td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>5</td>
                  <td>0.008</td>
                  <td>0.004</td>
                  <td>0.054</td>
                  <td>1.13</td>
                  <td>[-1.56, -0.44]</td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>6</td>
                  <td>0.003</td>
                  <td>0.002</td>
                  <td>0.042</td>
                  <td>0.93</td>
                  <td>[-1.46, -0.54]</td>
                </tr>
                <tr>
                  <td>IM</td>
                  <td>7</td>
                  <td>0.002</td>
                  <td>0.002</td>
                  <td>0.054</td>
                  <td>0.93</td>
                  <td>[-1.46, -0.54]</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>It can be seen that with five clusters, the proportion of placebo regressions significant at 5% is 0.05. The regression, placebo and synthetic outcome p values are 0.01, 0.004, and 0.01 respectively, not markedly different from BCH.</p>
<div class="cell" data-cache="true">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>syn_im<span class="ot">=</span><span class="fu">synth_im</span>(mobility<span class="sc">~</span>single_mothers<span class="sc">+</span>short_commute<span class="sc">+</span>gini<span class="sc">+</span>dropout_rate<span class="sc">+</span>social_cap<span class="sc">+</span>dropout_na,                                 opportunity,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">splines=</span><span class="dv">6</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pc_num=</span><span class="dv">15</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nSim=</span><span class="dv">1000</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_clus =</span> <span class="dv">7</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">synth_table</span>(syn_im)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_027he1jz6zn7p5zvnye1(i, j, css_id) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_027he1jz6zn7p5zvnye1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_027he1jz6zn7p5zvnye1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_027he1jz6zn7p5zvnye1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(0, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(1, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(2, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(3, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(4, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(5, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(6, 0, 'tinytable_css_id4sdwb22hjpaxoer2o5re') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 0, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 1, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 2, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 3, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 4, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
window.addEventListener('load', function () { styleCell_027he1jz6zn7p5zvnye1(7, 5, 'tinytable_css_idyq617yg1vg6szqf21uv4') })
    </script>

    <style>
    .table td.tinytable_css_id4sdwb22hjpaxoer2o5re, .table th.tinytable_css_id4sdwb22hjpaxoer2o5re {  font-weight: bold; }
    .table td.tinytable_css_idyq617yg1vg6szqf21uv4, .table th.tinytable_css_idyq617yg1vg6szqf21uv4 {  text-align: left; }
    </style>
    <div class="container">
      <table class="table table-striped" id="tinytable_027he1jz6zn7p5zvnye1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col">Adj</th>
                <th scope="col">Clusters</th>
                <th scope="col">Est p</th>
                <th scope="col">Synth p</th>
                <th scope="col">CI Width</th>
                <th scope="col">CI</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="6">Moran=15.69, Structure=0.88, Effective Range=0.15, R2=0.43.</td></tr>
<tr><td colspan="6">N=693, Splines=6, PCs=15.</td></tr>
<tr><td colspan="6">Estimated and synthetic outcome p values for different cluster numbers.
                R2 gives the explanatory power of a regression of the outcome on a quadratic in longitude and latitude.</td></tr></tfoot>
        <tbody>
                <tr>
                  <td>HC</td>
                  <td>.</td>
                  <td>0    </td>
                  <td>0    </td>
                  <td>0.28</td>
                  <td>[-1.14, -0.86]</td>
                </tr>
                <tr>
                  <td>IM</td>
                  <td>3</td>
                  <td>0.057</td>
                  <td>0.055</td>
                  <td>2.14</td>
                  <td>[-2.07, 0.07] </td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>4</td>
                  <td>0.023</td>
                  <td>0.022</td>
                  <td>1.48</td>
                  <td>[-1.74, -0.26]</td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>5</td>
                  <td>0.008</td>
                  <td>0.007</td>
                  <td>1.13</td>
                  <td>[-1.56, -0.44]</td>
                </tr>
                <tr>
                  <td>  </td>
                  <td>6</td>
                  <td>0.003</td>
                  <td>0.002</td>
                  <td>0.93</td>
                  <td>[-1.46, -0.54]</td>
                </tr>
                <tr>
                  <td>IM</td>
                  <td>7</td>
                  <td>0.002</td>
                  <td>0.004</td>
                  <td>0.93</td>
                  <td>[-1.46, -0.54]</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>Given that the IM confidence interval is considerably wider than the BCH one ( [-1.56,-0.44] here, compared with [-0.88,-0.13]) as is usually the case, the similar p-values arise because its central value is far lower than the BCH one. If we repeat the exercise for the other variables, short commute again has similar p-values to BCH and a high but wide interval. The other three variables have wide intervals centred near zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Var=</span><span class="fu">c</span>(<span class="st">"single_mothers"</span>,<span class="st">"short_commute"</span>,<span class="st">"gini"</span> ,          <span class="st">"dropout_rate"</span>,<span class="st">"short_commute"</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">reg=</span><span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.26</span>,<span class="fl">0.23</span>,<span class="fl">0.78</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">placebo=</span><span class="fu">c</span>(<span class="fl">0.00</span>,<span class="fl">0.01</span>,<span class="fl">0.21</span>,<span class="fl">0.21</span>,<span class="fl">0.80</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">synth=</span><span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.02</span>,<span class="fl">0.29</span>,<span class="fl">0.23</span>,<span class="fl">0.77</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI=</span><span class="fu">c</span>(<span class="st">"[-1.56,-0.44]"</span>,<span class="st">"[0.33,1.67]"</span>,<span class="st">"[-3.14,1.14]"</span>,<span class="st">"[-2.98,0.98]"</span>,<span class="st">"[-8.52,10.52]"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tt</span>(x,<span class="at">caption=</span><span class="st">"Regression, placebo, and synthetic p-values along with confidence intervals using IM inference."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_qd09xlgiyg3kq7r37947(i, j, css_id) {
        var table = document.getElementById("tinytable_qd09xlgiyg3kq7r37947");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_qd09xlgiyg3kq7r37947');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_qd09xlgiyg3kq7r37947(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_qd09xlgiyg3kq7r37947");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_qd09xlgiyg3kq7r37947(0, 0, 'tinytable_css_idsnosq3157sz4yc7rptm9') })
window.addEventListener('load', function () { styleCell_qd09xlgiyg3kq7r37947(0, 1, 'tinytable_css_idsnosq3157sz4yc7rptm9') })
window.addEventListener('load', function () { styleCell_qd09xlgiyg3kq7r37947(0, 2, 'tinytable_css_idsnosq3157sz4yc7rptm9') })
window.addEventListener('load', function () { styleCell_qd09xlgiyg3kq7r37947(0, 3, 'tinytable_css_idsnosq3157sz4yc7rptm9') })
window.addEventListener('load', function () { styleCell_qd09xlgiyg3kq7r37947(0, 4, 'tinytable_css_idsnosq3157sz4yc7rptm9') })
    </script>

    <style>
    .table td.tinytable_css_idsnosq3157sz4yc7rptm9, .table th.tinytable_css_idsnosq3157sz4yc7rptm9 {  border-bottom: solid 0.1em #d3d8dc; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_qd09xlgiyg3kq7r37947" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        </thead><caption>Regression, placebo, and synthetic p-values along with confidence intervals using IM inference.</caption>
              <tbody><tr>
                <th scope="col">Var</th>
                <th scope="col">reg</th>
                <th scope="col">placebo</th>
                <th scope="col">synth</th>
                <th scope="col">CI</th>
              </tr>
        
        
        </tbody><tbody>
                <tr>
                  <td>single_mothers</td>
                  <td>0.01</td>
                  <td>0.00</td>
                  <td>0.01</td>
                  <td>[-1.56,-0.44]</td>
                </tr>
                <tr>
                  <td>short_commute </td>
                  <td>0.01</td>
                  <td>0.01</td>
                  <td>0.02</td>
                  <td>[0.33,1.67]  </td>
                </tr>
                <tr>
                  <td>gini          </td>
                  <td>0.26</td>
                  <td>0.21</td>
                  <td>0.29</td>
                  <td>[-3.14,1.14] </td>
                </tr>
                <tr>
                  <td>dropout_rate  </td>
                  <td>0.23</td>
                  <td>0.21</td>
                  <td>0.23</td>
                  <td>[-2.98,0.98] </td>
                </tr>
                <tr>
                  <td>short_commute </td>
                  <td>0.78</td>
                  <td>0.80</td>
                  <td>0.77</td>
                  <td>[-8.52,10.52]</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The exponential kernel is a special case of the Matern function with smoothness parameter of 0.5, and in principle the optimal smoothing parameter can be chosen by maximum likelihood. In practice this makes little difference: as smoothness increases the estimated range <span class="math inline">\theta</span> falls, leaving correlation more or less unchanged.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The placebo and synthetic outcome tests run in parallel by default. If you encounter computational problems you should set the option <code>Parallel=FALSE</code> in each command. For large datasets, estimating the necessary Cholesky decomposition of the correlation matrix and the k-medoids clusters can be time-consuming, and fast approximations can be used by setting <code>k_medoids=FALSE</code> and <code>exact_cholesky=FALSE</code> in the <code>placebo</code> command. The latter requires the <code>BRISC</code> package.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See Table 3 in Conley and Kelly.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>